<!DOCTYPE html>
<html>
    <head>
        <title>Slot Finder</title>
        <meta charset="UTF-8">
        <meta name="author" content="Amal">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--        <style>
                    body{
                        background: #0cebeb;  /* fallback for old browsers */
                        background: -webkit-linear-gradient(to right, #29ffc6, #20e3b2, #0cebeb);  /* Chrome 10-25, Safari 5.1-6 */
                        background: linear-gradient(to right, #29ffc6, #20e3b2, #0cebeb); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
                    }
                </style>-->
    </head>
    <body>
        <!--<h1 style="text-align: center;">Slot Finder</h1>-->
        <div style="display:block;min-height:300px;">
            <div style="min-width:15%;float:left;">
                  <input type="radio" class="all" name="district_name" value="" checked="checked">
                  <label for="html">None</label><br>
                  <input type="radio" id="Alappuzha" name="district_name" value="301"  onchange="getValue(this)">
                  <label for="html">Alappuzha</label><br>
                  <input type="radio" id="Ernakulam" name="district_name" value="307" onchange="getValue(this)">
                  <label for="css">Ernakulam</label><br>
                  <input type="radio" id="Idukki" name="district_name" value="306" onchange="getValue(this)">
                  <label for="javascript">Idukki</label><br>
                  <input type="radio" id="Kannur" name="district_name" value="297" onchange="getValue(this)">
                  <label for="javascript">Kannur</label><br>
                  <input type="radio" id="Kasaragod" name="district_name" value="295" onchange="getValue(this)">
                  <label for="javascript">Kasaragod</label><br>
                  <input type="radio" id="Kollam" name="district_name" value="298" onchange="getValue(this)">
                  <label for="javascript">Kollam</label><br>
                  <input type="radio" id="Kottayam" name="district_name" value="304" onchange="getValue(this)">
                  <label for="javascript">Kottayam</label><br>
                  <input type="radio" id="Kozhikode" name="district_name" value="305" onchange="getValue(this)">
                  <label for="javascript">Kozhikode</label><br>
                  <input type="radio" id="Malappuram" name="district_name" value="302" onchange="getValue(this)">
                  <label for="javascript">Malappuram</label><br>
                  <input type="radio" id="Palakkad" name="district_name" value="308" onchange="getValue(this)">
                  <label for="javascript">Palakkad</label><br>
                  <input type="radio" id="Pathanamthitta" name="district_name" value="300" onchange="getValue(this)">
                  <label for="javascript">Pathanamthitta</label><br>
                  <input type="radio" id="Thiruvananthapuram" name="district_name" value="296" onchange="getValue(this)">
                  <label for="javascript">Thiruvananthapuram</label><br>
                  <input type="radio" id="Thrissur" name="district_name" value="303" onchange="getValue(this)">
                  <label for="javascript">Thrissur</label><br>
                  <input type="radio" id="Wayanad" name="district_name" value="299" onchange="getValue(this)">
                  <label for="javascript">Wayanad</label><br>
            </div>
            <div style="min-width:15%;float:left;">
                  <input type="radio" class="all" name="min_age_limit" checked="checked" value="">
                  <label for="html"> All </label><br>
                  <input type="radio" id="18" name="min_age_limit" value="18" >
                  <label for="html"> 18 & Above </label><br>
                  <input type="radio" id="18" name="min_age_limit" value="18" >
                  <label for="css"> 18-44 Only</label><br>
                  <input type="radio" id="45" name="min_age_limit" value="45" >
                  <label for="javascript"> 45 & Above </label><br>
            </div> 
            <div style="min-width:15%;float:left;">
                  <input type="radio" class="all" name="vaccine" value="" checked="checked">
                  <label for="javascript">All</label><br>
                  <input type="radio" id="Covishield" name="vaccine" value="COVISHIELD" >
                  <label for="javascript">Covishield</label><br>
                  <input type="radio" id="Covaxin" name="vaccine" value="COVAXIN" >
                  <label for="javascript">Covaxin</label><br>
                  <input type="radio" id="SputnikV" name="vaccine" value="SPUTNIKV" >
                  <label for="javascript">Sputnik V</label><br>
            </div>
            <div style="min-width:15%;float:left;">
                  <input type="radio" class="any" name="fee_type" value="" checked="checked">
                  <label for="javascript">Any</label><br>
                  <input type="radio" id="Free" name="fee_type" value="Free" >
                  <label for="javascript">Free</label><br>
                  <input type="radio" id="Paid" name="fee_type" value="Paid" >
                  <label for="javascript">Paid</label><br>
            </div>
            <div style="min-width:15%;float:left;">
                  <input type="radio" class="all" name="available_capacity_dose" value="" checked="checked">
                  <label for="javascript">Any</label><br>
                  <input type="radio" id="dose1" name="available_capacity_dose" value="1" >
                  <label for="javascript">Dose1</label><br>
                  <input type="radio" id="dose2" name="available_capacity_dose" value="2" >
                  <label for="javascript">Dose2</label><br>
            </div>
            <div style="min-width:15%;float:left;">
                <label>Pincode</label>
                <input id="pincode"  name="pincode" type="text" placeholder="eg: 695001,695002,695003" />
            </div>
        </div>
        <br/>
        <div style="display:block;text-align: center;" id="div_placeholder">

        </div>
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
    <script>
                    function getValue(radio) {
                        process();
                        var reloader = setInterval(function () {
                            var district_name = document.querySelector('input[name="district_name"]:checked').value;
                            if (district_name) {
                                process();
                            }
                        }, 7000);
//                        clearInterval(reloader);
                    }
                    var playsound = 0;
                    function process() {
                        var district_name = document.querySelector('input[name="district_name"]:checked').value;
                        var district_disp = document.querySelector('input[name="district_name"]:checked').id;
                        var vaccine = document.querySelector('input[name="vaccine"]:checked').value;
                        var min_age_limit = document.querySelector('input[name="min_age_limit"]:checked').value;
                        var fee_type = document.querySelector('input[name="fee_type"]:checked').value;
                        var available_capacity_dose = document.querySelector('input[name="available_capacity_dose"]:checked').value;
                        var pincode = document.querySelector('input[name="pincode"]').value;
                        var pincodeArr = pincode.split(',');
                        var currentDate = new Date();
//                        currentDate.setDate(currentDate.getDate() - 2);//today for testing
                        currentDate.setDate(currentDate.getDate() + 1);
                        var tommorrow = ("0" + currentDate.getDate()).slice(-2) + "-" + ("0" + (currentDate.getMonth() + 1)).slice(-2) + "-" + currentDate.getFullYear();
                        var path = 'https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/findByDistrict?district_id=' + district_name + '&date=' + tommorrow;
                        $.ajax({
                            url: path,
                            type: "GET",
                            success: function (response) {
                                var sessions = response.sessions;

                                var table = '<h2>Checking slot availability for ' + district_disp + ' on ' + tommorrow + '</h2>. Refreshing in <span id="timer"></span>';
                                table += '<table border="1" style="width:100%">';
                                table += '<tr>';
                                table += '<th>Sl No.</th>';
                                table += '<th>Min. Age</th>';
                                table += '<th>Fee Type</th>';
                                table += '<th>Vaccine</th>';
                                table += '<th>Dose 1</th>';
                                table += '<th>Dose 2</th>';
                                table += '<th>Session</th>';
                                table += '<th>Center Name</th>';
                                table += '<th>Pincode</th>';
                                table += '</tr>';
                                var i = 1;
                                var availability_count = 0;
                                for (const resp of sessions) { // You can use `let` instead of `const` if you like
//                                    console.log(!vaccine || vaccine === resp.vaccine);
//                                    console.log(!fee_type || fee_type === resp.fee_type);
//                                    console.log((!available_capacity_dose && (resp.available_capacity_dose1 > 1 || resp.available_capacity_dose2 > 1)) || ((available_capacity_dose === 1 && resp.available_capacity_dose1 > 1) || (available_capacity_dose === 2 && resp.available_capacity_dose2 > 1)));
//                                    console.log(!pincode || pincode === resp.pincode);
//                                    console.log(!min_age_limit || min_age_limit === resp.min_age_limit);
//                                    return false;
                                    if (!vaccine || vaccine === resp.vaccine) {
                                        if (!fee_type || fee_type === resp.fee_type) {
                                            if ((!available_capacity_dose && (resp.available_capacity_dose1 > 1 || resp.available_capacity_dose2 > 1)) || ((available_capacity_dose === 1 && resp.available_capacity_dose1 > 1) || (available_capacity_dose === 2 && resp.available_capacity_dose2 > 1))) {
                                                if (!pincode || pincodeArr.includes(String(resp.pincode))) {
//                                                if (!pincode || pincode === resp.pincode) {
                                                    if (!min_age_limit || min_age_limit === resp.min_age_limit) {
                                                        table += '<tr>';
                                                        table += '<td>' + i + '</td>';
                                                        table += '<td>' + resp.min_age_limit + '</td>';
                                                        table += '<td>' + resp.fee_type + '</td>';
                                                        table += '<td>' + resp.vaccine + '</td>';
                                                        table += '<td>' + resp.available_capacity_dose1 + '</td>';
                                                        table += '<td>' + resp.available_capacity_dose2 + '</td>';
                                                        table += '<td>' + resp.from + '-' + resp.to + '</td>';
                                                        table += '<td>' + resp.name + '</td>';
                                                        table += '<td>' + resp.pincode + '</td>';
                                                        table += '</tr>';
                                                        i = i + 1;
                                                        availability_count = availability_count + 1;
                                                        playsound = 1;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                startCount();
                                if (sessions.length < 1 || availability_count === 0) {
                                    table += '<tr><td colspan="9">No Records Available</td></tr>';
                                    $('#div_placeholder').html('');
                                    $('#div_placeholder').html(table);
                                    return false;
                                }
                                if (playsound === 1) {
                                    var myAudio = new Audio('buzzer.wav');
                                    myAudio.play();
                                }
                                table += '</table>';
                                $('#div_placeholder').html('');
                                $('#div_placeholder').html(table);
                            }
                        });

                    }

                    function startCount() {
                        var c = 7;
                        var timer = setInterval(function () {
                            if (c <= 1) {
                                clearInterval(timer);
                            }
                            document.getElementById("timer").innerHTML = c;
                            c = c - 1;
                        }, 1000);
                    }
    </script>
</html>


